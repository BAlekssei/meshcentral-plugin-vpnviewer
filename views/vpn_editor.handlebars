<div style="padding:16px">
  <h2 style="margin:0 0 12px">Редактор: /etc/systemd/network/10-vpn_vpn.network</h2>
  <div id="status" style="margin:8px 0 12px; font-size:13px; color:#9ecbff;"></div>
  <div style="margin-bottom:8px">
    <button id="btnProbe">Проверка модуля</button>
    <button id="btnLoad" style="margin-left:8px">Загрузить</button>
    <button id="btnSave" style="margin-left:8px">Сохранить</button>
  </div>
  <textarea id="editor" spellcheck="false"
    style="width:100%; height:560px; font-family:monospace; font-size:13px; border:1px solid #333; background:#0b0b0b; color:#d8d8d8; padding:10px; border-radius:4px;"></textarea>
</div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const node = qs.get('node') || '';
  const path = '/etc/systemd/network/10-vpn_vpn.network';
  const st = document.getElementById('status'), ed = document.getElementById('editor');

  function setStatus(msg, ok=true){ st.style.color = ok ? '#9ecbff' : '#ff8a8a'; st.textContent = msg || ''; }
  async function api(action, body){
    const url = `/pluginadmin.ashx?pin=vpnviewer&user=1&action=${action}&node=${encodeURIComponent(node)}&path=${encodeURIComponent(path)}`;
    const opt = body ? { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) } : {};
    const r = await fetch(url, opt); return r.json();
  }

  document.getElementById('btnProbe').onclick = async () => {
    setStatus('Проверяю модуль агента…');
    const r = await api('probe').catch(e => ({ok:false,error:String(e)}));
    if (r.ok) setStatus('OK: агентный модуль загружен.');
    else setStatus('Модуль не отвечает: ' + (r.error||'unknown'), false);
  };

  document.getElementById('btnLoad').onclick = async () => {
    setStatus('Читаю файл с агента…');
    const r = await api('read').catch(e => ({ok:false,error:String(e)}));
    if (r.ok) { ed.value = r.content || ''; setStatus('Файл загружен.'); }
    else setStatus('Ошибка чтения: ' + (r.error||'unknown'), false);
  };

  document.getElementById('btnSave').onclick = async () => {
    setStatus('Сохраняю файл на агенте…');
    const r = await api('write', { content: ed.value }).catch(e => ({ok:false,error:String(e)}));
    if (r.ok) setStatus('Сохранено.');
    else setStatus('Ошибка записи: ' + (r.error||'unknown'), false);
  };

  // авто-проверка и загрузка
  document.getElementById('btnProbe').click();
  setTimeout(()=>document.getElementById('btnLoad').click(), 300);
})();
</script>
