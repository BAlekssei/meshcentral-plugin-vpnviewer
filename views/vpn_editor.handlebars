<div style="padding:10px;color:#ddd">
  <h2>Plugins</h2>
  <p>Это вкладка, добавленная плагином <b>vpnviewer</b>. Редактор файла <code>/etc/systemd/network/10-vpn_vpn.network</code>.</p>

  <div style="margin:10px 0;">
    <button id="vv_ping">Проверка связи с агентом</button>
    <button id="vv_load">Открыть файл</button>
    <button id="vv_save">Сохранить</button>
    <span id="vv_status" style="margin-left:10px;"></span>
  </div>
  <textarea id="vv_text" style="width:100%;height:520px;background:#111;color:#ddd;border:1px solid #333;border-radius:4px;padding:8px;font-family:monospace;"></textarea>
</div>

<script>
(function(){
  const filePath = '/etc/systemd/network/10-vpn_vpn.network';
  const nodeid = currentNode._id; // есть на странице устройства
  const $s = (t)=>document.getElementById('vv_status').textContent=t;

  async function ajax(a, body){
    const u = `/pluginadmin.ashx?pin=vpnviewer&${a}&nodeid=${encodeURIComponent(nodeid)}`;
    const opt = body ? {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)} : {};
    const r = await fetch(u, opt);
    if (!r.ok) throw new Error(await r.text());
    return r.json ? r.json() : r.text();
  }

  document.getElementById('vv_ping').onclick = async ()=>{
    $s('Пингую агент…');
    try { const r = await ajax('a=ping'); $s(r.ok ? 'ОК: агент отвечает' : 'Агент не ответил'); } catch(e){ $s('Ошибка: '+e.message); }
  };

  document.getElementById('vv_load').onclick = async ()=>{
    $s('Читаю файл с агента…');
    try {
      const r = await ajax(`a=read&file=${encodeURIComponent(filePath)}`);
      document.getElementById('vv_text').value = r.data || '';
      $s('Файл открыт');
    } catch(e){ $s('Ошибка чтения: '+e.message); }
  };

  document.getElementById('vv_save').onclick = async ()=>{
    $s('Сохраняю…');
    try {
      await ajax('a=write', { file: filePath, data: document.getElementById('vv_text').value });
      $s('Сохранено');
    } catch(e){ $s('Ошибка сохранения: '+e.message); }
  };
})();
</script>
